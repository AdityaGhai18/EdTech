---
import Container from "../components/shared/Container.astro";
import Layout from "../layouts/Layout.astro";


// Hardcoded data for MVP
const dashboardData = {
    user: {
        name: "Ana Smith",
        balance: {
            stablecoin: 185.78,
            localCurrency: 185.78,
            currency: "USDU"
        }
    },
    accounts: [
        {
            country: "United States",
            flag: "ðŸ‡ºðŸ‡¸",
            currency: "USDU",
            balance: 47.56,
            accountNumber: "53028",
            localEquivalent: 47.56
        },
        {
            country: "Mexico",
            flag: "ðŸ‡²ðŸ‡½",
            currency: "USDU",
            balance: 93.26,
            accountNumber: "53028",
            localEquivalent: 93.26
        },
        {
            country: "Switzerland",
            flag: "ðŸ‡¨ðŸ‡­",
            currency: "USDU",
            balance: 44.96,
            accountNumber: "71207",
            localEquivalent: 44.96
        }
    ],
    transactions: [
        {
            name: "John",
            type: "sent",
            date: "Oct 11",
            amount: -242.38,
            currency: "USDU",
            icon: "â†‘",
            party: "John Smith"
        },
        {
            name: "Internal Transfer",
            type: "moved",
            date: "Oct 11",
            amount: 15.66,
            currency: "USDU",
            icon: "â†”",
            party: "Own Account"
        },
        {
            name: "Sophia",
            type: "received",
            date: "Oct 11",
            amount: 227.85,
            currency: "USDU",
            icon: "â†“",
            party: "Sophia Chen"
        }
    ],
    info: {
        settlementNote: "Transfers settle within minutes with minimal fees.",
        disclaimer: "All values shown are estimates. Actual exchange rates may vary."
    }
};
---

<Layout title="Dashboard">
    <div class="min-h-screen bg-body">
        <!-- Main content -->
        <main class="p-6 mt-32">
            <Container>
                <div class="max-w-4xl mx-auto px-2 sm:px-0">
                
                <div class="max-w-4xl mx-auto">
                    <!-- Welcome & Title -->
                    <div class="flex flex-col gap-y-2 mb-8">
                        <h1 class="text-heading-1 text-3xl font-semibold">Dashboard</h1>
                        <p class="text-gray-600" data-welcome-name>Welcome back, Guest</p>
                    </div>
                    
                    <!-- Balance Section -->
                    <div class="mb-8">
                        <h2 class="text-heading-2 text-sm mb-2">Total balance</h2>
                        <div class="text-heading-1 text-4xl font-semibold">
                            {dashboardData.user.balance.stablecoin.toFixed(2)}{" "}{dashboardData.user.balance.currency}
                        </div>
                        <div class="text-gray-600 mt-1">
                            â‰ˆ ${dashboardData.user.balance.localCurrency.toFixed(2)} USD
                        </div>
                    </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 mb-8">
                    <button class="px-6 py-2 bg-[#4F46E5] text-white rounded-full hover:bg-[#4338CA] transition-colors">
                        Send
                    </button>
                    <button class="px-6 py-2 bg-[#4F46E5] text-white rounded-full hover:bg-[#4338CA] transition-colors">
                        Add money
                    </button>
                    <button class="px-6 py-2 bg-[#4F46E5] text-white rounded-full hover:bg-[#4338CA] transition-colors">
                        Request
                    </button>
                    <button 
                        id="testButton"
                        class="px-6 py-2 bg-[#4F46E5] text-white rounded-full hover:bg-[#4338CA] transition-colors">
                        Test
                    </button>
                </div>

                <!-- test input into user document with bank example -->
                <div id="testModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div class="bg-white p-8 rounded-xl max-w-md w-full">
                        <h2 class="text-2xl font-semibold mb-4">Enter Bank Number</h2>
                        <input 
                            type="text" 
                            id="bankNumber"
                            placeholder="Enter bank number"
                            class="w-full px-4 py-2 border rounded-md mb-4"
                        />
                        <div class="flex justify-end gap-4">
                            <button id="cancelButton" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Cancel
                            </button>
                            <button id="submitButton" class="px-4 py-2 bg-[#4F46E5] text-white rounded-md hover:bg-[#4338CA]">
                                Submit
                            </button>
                        </div>
                    </div>
                </div>                

                <!-- Account Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- US Account -->
                    <div class="bg-box-bg p-6 rounded-xl border border-box-border">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                                ðŸ‡ºðŸ‡¸
                            </div>
                            <div>
                                <h3 class="text-heading-1 font-medium">USDG</h3>
                                <p class="text-heading-2 text-sm">(United States)</p>
                            </div>
                        </div>
                        <p class="text-heading-1 text-2xl font-medium">47.56</p>
                        <p class="text-heading-2 text-sm">â€¢â€¢â€¢â€¢ 53028</p>
                    </div>

                    <!-- Mexico Account -->
                    <div class="bg-box-bg p-6 rounded-xl border border-box-border">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                                ðŸ‡²ðŸ‡½
                            </div>
                            <div>
                                <h3 class="text-heading-1 font-medium">USDG</h3>
                                <p class="text-heading-2 text-sm">(Mexico)</p>
                            </div>
                        </div>
                        <p class="text-heading-1 text-2xl font-medium">93.26</p>
                        <p class="text-heading-2 text-sm">â€¢â€¢â€¢â€¢ 53028</p>
                    </div>

                    <!-- Switzerland Account -->
                    <div class="bg-box-bg p-6 rounded-xl border border-box-border">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                                ðŸ‡¨ðŸ‡­
                            </div>
                            <div>
                                <h3 class="text-heading-1 font-medium">USDG</h3>
                                <p class="text-heading-2 text-sm">(Switzerland)</p>
                            </div>
                        </div>
                        <p class="text-heading-1 text-2xl font-medium">44.96</p>
                        <p class="text-heading-2 text-sm">â€¢â€¢â€¢â€¢ 71207</p>
                    </div>
                </div>

                <!-- Transactions Section -->
                <div class="bg-box-bg rounded-xl border border-box-border p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-heading-1 text-xl font-semibold">Transactions</h2>
                        <button class="text-indigo-600 hover:text-indigo-700">See all</button>
                    </div>
                    <div class="space-y-4">
                        <!-- Transaction items -->
                        <div class="flex items-center justify-between py-2 border-b border-box-border">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                    â†‘
                                </div>
                                <div>
                                    <p class="text-heading-1">John</p>
                                    <p class="text-heading-2 text-sm">Sent Â· Oct 11</p>
                                </div>
                            </div>
                            <p class="text-heading-1">-242.38 USD</p>
                        </div>

                        <div class="flex items-center justify-between py-2 border-b border-box-border">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                    â†”
                                </div>
                                <div>
                                    <p class="text-heading-1">To your USD balance</p>
                                    <p class="text-heading-2 text-sm">Moved Â· Oct 11</p>
                                </div>
                            </div>
                            <p class="text-heading-1">15.66 USD</p>
                        </div>

                        <div class="flex items-center justify-between py-2 border-b border-box-border">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                    â†“
                                </div>
                                <div>
                                    <p class="text-heading-1">Sophia</p>
                                    <p class="text-heading-2 text-sm">Oct 11</p>
                                </div>
                            </div>
                            <p class="text-heading-1 text-green-500">+227.85 USD</p>
                        </div>
                    </div>

                    <!-- Additional Info -->
                    <div class="text-sm text-gray-500 mt-6">
                        <p>{dashboardData.info.settlementNote}</p>
                        <p class="mt-2">{dashboardData.info.disclaimer}</p>
                    </div>
                </div>
            </Container>
        </main>
    </div>
    <script>
        import { auth, db } from '../lib/firebase/client';
        import { doc, updateDoc, arrayUnion, getDoc, setDoc } from 'firebase/firestore';

        // Welcome message handler
        window.addEventListener('DOMContentLoaded', async () => {
            const user = auth.currentUser;
            const welcomeElement = document.querySelector('[data-welcome-name]');
            if (welcomeElement && user) {
                welcomeElement.textContent = `Welcome back, ${user.displayName || 'Guest'}`;
            }
        });

        // Test button and modal handlers
        const testButton = document.getElementById('testButton');
        const testModal = document.getElementById('testModal');
        const cancelButton = document.getElementById('cancelButton');
        const submitButton = document.getElementById('submitButton');
        const bankNumberInput = document.getElementById('bankNumber');

        // Show modal
        testButton?.addEventListener('click', () => {
            testModal?.classList.remove('hidden');
        });

        // Hide modal
        cancelButton?.addEventListener('click', () => {
            testModal?.classList.add('hidden');
            bankNumberInput.value = '';
        });

        // Submit data
        submitButton?.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                alert('Please log in first');
                return;
            }

            const bankNumber = bankNumberInput?.value;
            if (!bankNumber) {
                alert('Please enter a bank number');
                return;
            }

            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    // Add bank number to existing user document
                    await updateDoc(userDocRef, {
                        bankNumbers: arrayUnion({
                            number: bankNumber,
                            addedAt: new Date().toISOString()
                        })
                    });
                } else {
                    // Create new user document with bank number
                    await setDoc(userDocRef, {
                        email: user.email,
                        name: user.displayName,
                        createdAt: new Date().toISOString(),
                        bankNumbers: [{
                            number: bankNumber,
                            addedAt: new Date().toISOString()
                        }]
                    });
                }

                alert('Bank number added successfully!');
                testModal?.classList.add('hidden');
                bankNumberInput.value = '';
            } catch (error) {
                console.error('Error adding bank number:', error);
                alert('Error adding bank number');
            }
        });
    </script>

</Layout>